<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Frederiksberg Elite</title>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- My custom styles -- local .css-file -->
  <link rel="stylesheet" href="web/styles.css">

</head>
<body>
  <h1>Ranking</h1>

    <script src="web/shared.js"></script>


  <div class="season-selector">
    <label for="season">Select season:</label>
    <select id="season">
      <option value="2025_2026" selected>2025/2026</option>
      <option value="2024_2025">2024/2025</option>
      <option value="all_time">All Time</option>
    </select>
  </div>

  <div class="top-controls">

  <div class="tabs">
        <button class="tab-button active" data-stat="top_scorer">Top Scorers</button>
        <button class="tab-button" data-stat="top_offense">Best Hitter</button>
        <button class="tab-button" data-stat="top_blocker">Best Blocker</button>
        <button class="tab-button" data-stat="top_digger">Most Digs</button>
        <button class="tab-button" data-stat="top_server">Best Server</button>
        <button class="tab-button" data-stat="top_passer">Best Passer</button>

    </div>
        <div id="topScorer"></div>

  </div>

    <div class="stats-container">
        <canvas id="pointsChart"></canvas>
        <table id="statsTable" class="display" style="width:50%">
            <thead>
                <tr></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>



  <script>
    
    const seasonSelect = document.getElementById("season");
    const tabButtons = document.querySelectorAll(".tab-button");
    const topScorerDiv = document.getElementById("topScorer");
    let currentSeason = seasonSelect.value;
    let currentStat = "top_scorer";
    let dataTable;
    let chart;

    // Mapping for which columns to show per stat
    const statColumns = {
      top_scorer: ["player","total_earned","points_per_set"],
      top_offense: ["player","hitting_efficiency","total_kills","kill_percentage"],
      top_blocker: ["player","blocks","blocks_per_set"],
      top_digger: ["player","digs","digs_per_set"],
      top_server: ["player","aces","average_serve_rating", "ace_percentage", "point_scoring_pct"],
      top_passer: ["player","average_pass_rating", "positive_pct", "perfect_pct"]
    };

    // Column headers for table
    const columnHeaders = {
      top_scorer: ["Player","Total Points","Points/Set"],
      top_offense: ["Player","Kill Efficiency","Total Kills","Kill %"],
      top_blocker: ["Player","Total Blocks","Blocks/Set"],
      top_digger: ["Player","Total Digs","Digs/Set"],
      top_server: ["Player","Total Aces","Serve Rating", "Ace %", "Points Won %"],
      top_passer: ["Player","Pass Rating", "Positive %", "Perfect %"]
    };

    function getFilePath(season, stat) {
      if (season === "all_time") {
        return `../all_time_${stat}.json`;
      } else {
        return `../${season}_${stat}.json`;
      }
    }

    function loadStats(season, stat) {
      const filePath = getFilePath(season, stat);
      fetch(filePath)
        .then(resp => resp.json())
        .then(data => displayStats(data))
        .catch(err => {
          console.error("Error loading data", err);
          topScorerDiv.textContent = "Error loading data.";
        });
    }

    function displayStats(data) {
      // Sort by first numeric column descending (usually total points/blocks/etc)
      const firstNumericKey = statColumns[currentStat][1];
      const sorted = data.sort((a,b)=> b[firstNumericKey] - a[firstNumericKey]);

      // Display top player
      const topLabels = {
            top_scorer: "points",
            top_blocker: "blocks",
            top_digger: "digs",
            top_server: "aces",
            top_passer: "rating",
            top_offense: "efficiency"
        };

      const label = topLabels[currentStat] || "points";

      const topPlayer = sorted[0];
let displayValue = topPlayer[firstNumericKey];

// For "top_offense", format to .123 (three decimals, no leading zero)
if (currentStat === "top_offense") {
  displayValue = displayValue.toFixed(3);
  // Remove leading zero if present (e.g., 0.123 â†’ .123)
  if (displayValue.startsWith("0")) displayValue = displayValue.slice(0);
}

topScorerDiv.textContent = `ðŸ† Top ${currentStat.replace("top_","").replace("_"," ")}: ${topPlayer.player} â€” ${displayValue} ${label}`;

// Table data
const cols = statColumns[currentStat];
const headers = columnHeaders[currentStat];
    
    // Define which columns are integers
        const formatters = {
            // Count columns â†’ integers
            total_earned: v => Math.round(v),
            total_errors: v => Math.round(v),
            total_blocks: v => Math.round(v),
            total_digs: v => Math.round(v),
            total_aces: v => Math.round(v),
            
            // Ratios / averages â†’ 2 decimals
            points_per_set: v => v.toFixed(2),
            points_per_match: v => v.toFixed(2),
            errors_per_set: v => v.toFixed(2),
            errors_per_match: v => v.toFixed(2),
            blocks_per_set: v => v.toFixed(2),
            digs_per_set: v => v.toFixed(2),
            aces_per_set: v => v.toFixed(2),
            average_serve_rating: v => v.toFixed(2),

            // Percentages (example: 0.45 â†’ 45%)
            ace_percentage: v => (v).toFixed(0) + "%",
            kill_percentage: v => (v).toFixed(0) + "%",
            error_pct: v => (v).toFixed(1) + "%",
            positive_pct: v => (v).toFixed(1) + "%",
            perfect_pct: v => (v).toFixed(1) + "%",
            points_won_percentage: v => (v).toFixed(0) +"%",
            point_scoring_pct: v => (v).toFixed(0) +"%",

            // Ratios like ".123" â†’ show 3 decimals
            serve_efficiency: v => v.toFixed(3),
            hitting_efficiency: v => v.toFixed(3),
            average_pass_rating: v => v.toFixed(2),
            hitting_efficiency: v => v.toFixed(3)
        };

        const tableData = sorted.map(p =>
            cols.map(k => {
                if (typeof p[k] === "number" && formatters[k]) {
                return formatters[k](p[k]);
                }
                return p[k]; // non-numbers stay as-is
            })
            );

      // Update table headers
      const thead = document.querySelector("#statsTable thead tr");
      thead.innerHTML = "";
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        thead.appendChild(th);
      });

      // Destroy old table
        const table = $("#statsTable");

        // Completely remove DataTable and all table contents
        if ($.fn.DataTable.isDataTable(table)) {
                table.DataTable().clear().destroy();
            }

        // Clear both <thead> and <tbody>
        table.find("thead").empty();
        table.find("tbody").empty();

        
        

      dataTable = $('#statsTable').DataTable({
        data: tableData,
        columns: headers.map(h => ({title:h})),
        order: [[1,'desc']],
        paging:false,
        info:false,
        searching:false
      });


      // Chart
      const labels = sorted.map(p => p.player);
      const values = sorted.map(p => p[firstNumericKey]);
      const fontSize = window.innerWidth < 600 ? 12 : 14;

      if (chart) chart.destroy();
      const ctx = document.getElementById("pointsChart").getContext("2d");
      chart = new Chart(ctx, {
        type:"bar",
        data:{
          labels:labels,
          datasets:[{
            label: headers[1],
            data:values,
            backgroundColor:"#0047ab",
            borderColor:"#0047ab",
            borderWidth:1
          }]
        },
        options:{
          indexAxis:"y",
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            title:{display:true, text:headers[1] + " by Player", font:{size:fontSize+2}}
          },
          scales:{
            x:{beginAtZero:true, ticks:{font:{size:fontSize}}},
            y:{ticks:{font:{size:fontSize}, autoSkip:false}}
          }
        }
      });
    }

    // Tab click handler
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentStat = btn.dataset.stat;
        loadStats(currentSeason, currentStat);
      });
    });

    // Season selector handler
    seasonSelect.addEventListener("change", () => {
      currentSeason = seasonSelect.value;
      loadStats(currentSeason, currentStat);
    });

    // Initial load
    loadStats(currentSeason, currentStat);
  </script>
</body>
</html>
